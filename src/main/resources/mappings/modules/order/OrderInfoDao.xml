<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mall.modules.order.dao.OrderInfoDao">

	<sql id="orderInfoColumns">
		a.id AS "id",
		a.order_no AS "orderNo",
		a.merchant_code AS "merchantCode",
		a.order_status AS "orderStatus",
		a.order_type AS "orderType",
		a.goods_count AS "goodsCount",
		a.goods_amount_total AS "goodsAmountTotal",
		a.logistics_fee AS "logisticsFee",
		a.order_amount_total AS "orderAmountTotal",
		a.discount_amount_total AS "discountAmountTotal",
		a.create_date AS "createDate",
		a.create_by AS "createBy.id",
		a.customer_code AS "customerCode",
		a.remarks AS "remarks",
		a.pay_time AS "payTime",
		a.pay_channel_time AS "payChannelTime",
		a.coupon_code AS "couponCode",
		a.discount_rate AS "discountRate",
		a.payment_no AS "paymentNo",
		a.update_by AS "updateBy.id",
		a.update_date AS "updateDate",
		a.closed_time AS "closedTime",
		a.auto_closed_time AS "autoClosedTime",
		a.completed_time AS "completedTime",
		a.auto_completed_time AS "autoCompletedTime",
		a.activity_discount_amount AS "activityDiscountAmount",
		a.activity_id AS "activityId",
		a.settlements_amount as "settlementsAmount",
		a.set_flag as "setFlag",
		a.remind_flag as "remindFlag",
		a.delivery_time as "deliveryTime"
	</sql>

	<resultMap id="OrderInfoDetail" type="OrderInfo">
		<id property="id" column="id"/>
		<result property="orderNo" column="orderNo"/>
		<result property="merchantCode" column="merchantCode"/>
		<result property="orderStatus" column="orderStatus"/>
		<result property="orderType" column="orderType"/>
		<result property="goodsCount" column="goodsCount"/>
		<result property="goodsAmountTotal" column="goodsAmountTotal"/>
		<result property="logisticsFee" column="logisticsFee"/>
		<result property="orderAmountTotal" column="orderAmountTotal"/>
		<result property="discountAmountTotal" column="discountAmountTotal"/>
		<result property="createDate" column="createDate"/>
		<result property="createBy.id" column="createBy"/>
		<result property="customerCode" column="customerCode"/>
		<result property="remarks" column="remarks"/>
		<result property="payTime" column="payTime"/>
		<result property="payChannelTime" column="payChannelTime"/>
		<result property="couponCode" column="couponCode"/>
		<result property="discountRate" column="discountRate"/>
		<result property="paymentNo" column="paymentNo"/>
		<result property="updateBy.id" column="updateBy"/>
		<result property="updateDate" column="updateDate"/>
		<result property="closedTime" column="closedTime"/>
		<result property="autoClosedTime" column="autoClosedTime"/>
		<result property="completedTime" column="completedTime"/>
		<result property="merchantName" column="merchantName"/>
		<result property="autoCompletedTime" column="autoCompletedTime"/>
		<result property="activityDiscountAmount" column="activityDiscountAmount"/>
		<result property="activityId" column="activityId"/>
		<result property="settlementsAmount" column="settlementsAmount"/>
		<result property="setFlag" column="setFlag"/>
		<result property="remindFlag" column="remindFlag"/>
		<association property="orderLogistics" javaType="OrderLogistics">
			<id property="id" column="logistics.id"/>
			<result property="expressNo" column="logistics.expressNo"/>
			<result property="consigneeRealname" column="logistics.consigneeRealname"/>
			<result property="consigneeTelphone" column="logistics.consigneeTelphone"/>
			<result property="consigneeTelphoneBackup" column="logistics.consigneeTelphoneBackup"/>
			<result property="consigneeAddress" column="logistics.consigneeAddress"/>
			<result property="consigneeZip" column="logistics.consigneeZip"/>
			<result property="logisticsType" column="logistics.logisticsType"/>
			<result property="logisticsId" column="logistics.logisticsId"/>
			<result property="logisticsFee" column="logistics.logisticsFee"/>
			<result property="orderlogisticsStatus" column="logistics.orderlogisticsStatus"/>
			<result property="logisticsResultLast" column="logistics.logisticsResultLast"/>
			<result property="logisticsResult" column="logistics.logisticsResult"/>
			<result property="logisticsCreateTime" column="logistics.logisticsCreateTime"/>
			<result property="logisticsUpdateTime" column="logistics.logisticsUpdateTime"/>
			<result property="provinceName" column="logistics.provinceName"/>
			<result property="countryName" column="logistics.countryName"/>
			<result property="cityName" column="logistics.cityName"/>
			<result property="areaName" column="logistics.areaName"/>
		</association>
		<collection property="orderGoodsList" ofType="OrderGoods">
			<id property="id" column="orderGoodsList.id"/>
			<result property="goodsId" column="orderGoodsList.goodsId"/>
			<result property="goodsCategoryId" column="orderGoodsList.goodsCategoryId"/>
			<result property="goodsName" column="orderGoodsList.goodsName"/>
			<result property="goodsBarcode" column="orderGoodsList.goodsBarcode"/>
			<result property="goodsTitle" column="orderGoodsList.goodsTitle"/>
			<result property="goodsType" column="orderGoodsList.goodsType"/>
			<result property="unit" column="orderGoodsList.unit"/>
			<result property="image" column="orderGoodsList.image"/>
			<result property="goodsDesp" column="orderGoodsList.goodsDesp"/>
			<result property="goodsPrice" column="orderGoodsList.goodsPrice"/>
			<result property="discountRate" column="orderGoodsList.discountRate"/>
			<result property="discountAmount" column="orderGoodsList.discountAmount"/>
			<result property="count" column="orderGoodsList.count"/>
			<result property="subtotal" column="orderGoodsList.subtotal"/>
			<result property="activityDiscountAmount" column="orderGoodsList.activityDiscountAmount"/>
		</collection>
	</resultMap>

	<sql id="orderInfoDetailColumns">
		a.id AS "id",
		a.order_no AS "orderNo",
		a.merchant_code AS "merchantCode",
		a.order_status AS "orderStatus",
		a.order_type AS "orderType",
		a.goods_count AS "goodsCount",
		a.goods_amount_total AS "goodsAmountTotal",
		a.logistics_fee AS "logisticsFee",
		a.order_amount_total AS "orderAmountTotal",
		a.discount_amount_total AS "discountAmountTotal",
		a.create_date AS "createDate",
		a.create_by AS "createBy.id",
		a.customer_code AS "customerCode",
		a.remarks AS "remarks",
		a.pay_time AS "payTime",
		a.pay_channel_time AS "payChannelTime",
		a.coupon_code AS "couponCode",
		a.discount_rate AS "discountRate",
		a.payment_no AS "paymentNo",
		a.update_by AS "updateBy.id",
		a.update_date AS "updateDate",
		a.closed_time AS "closedTime",
		a.auto_closed_time AS "autoClosedTime",
		a.completed_time AS "completedTime",
		a.auto_completed_time AS "autoCompletedTime",
		a.activity_discount_amount AS "activityDiscountAmount",
		a.activity_id AS "activityId",
		a.set_flag AS "setFlag",
		a.remind_flag AS "remindFlag",
		m.nickname AS "merchantName",
		l.id AS "logistics.id",
		l.express_no AS "logistics.expressNo",
		l.consignee_realname AS "logistics.consigneeRealname",
		l.consignee_telphone AS "logistics.consigneeTelphone",
		l.consignee_telphone_backup AS "logistics.consigneeTelphoneBackup",
		l.consignee_address AS "logistics.consigneeAddress",
		l.consignee_zip AS "logistics.consigneeZip",
		l.logistics_type AS "logistics.logisticsType",
		l.logistics_id AS "logistics.logisticsId",
		l.logistics_fee AS "logistics.logisticsFee",
		l.orderlogistics_status AS "logistics.orderlogisticsStatus",
		l.logistics_result_last AS "logistics.logisticsResultLast",
		l.logistics_result AS "logistics.logisticsResult",
		l.logistics_create_time AS "logistics.logisticsCreateTime",
		l.province_name AS "logistics.provinceName",
		l.country_name AS "logistics.countryName",
		l.city_name AS "logistics.cityName",
		l.area_name AS "logistics.areaName"
	</sql>

	<sql id="orderInfoJoins">
	</sql>

	<select id="get" resultType="OrderInfo">
		SELECT
			<include refid="orderInfoColumns"/>,
			m.nickname as "merchantName",
			c.nickname as "customerName",
		    m.referee as "merchantAccount",
		    c.referee as "customerAccount"
		FROM order_info a
		<include refid="orderInfoJoins"/>
			left join member_info m on m.id = a.merchant_code
			left join member_info c on c.id = a.customer_code
		WHERE a.id = #{id}
	</select>

	<select id="getOrderBasicInfo" resultType="OrderInfo">
		select <include refid="orderInfoColumns"/>
		from order_info a
		<include refid="orderInfoJoins"/>
		where a.id = #{id} and a.customer_code = #{customerCode}
	</select>

	<select id="orderCount" resultType="Map">
		select count(0)                   as total,
			   IFNULL(sum(if(order_status = 0, 1, 0)),0) as pendingPay,
			   IFNULL(sum(if(order_status = 1, 1, 0)),0) as pendingDeliver,
			   IFNULL(sum(if(order_status = 2, 1, 0)),0) as pendingTake,
			   IFNULL(sum(if(order_status = 3, 1, 0)),0) as completed,
			   IFNULL(sum(if(order_status = 4, 1, 0)),0) as closed,
			   IFNULL(sum(if(order_status = 5, 1, 0)),0) as pendingReturn,
			   IFNULL(sum(if(order_status = 6, 1, 0)),0) as returned
		from order_info where customer_code = #{customerCode}
	</select>

    <select id="findOrderDetailList" resultMap="OrderInfoDetail">
        select
        <include refid="orderInfoDetailColumns"/>
        from order_info a
        left join member_info m on m.id=a.merchant_code
        left join order_logistics l on l.order_no = a.order_no
        <where>
            <if test="customerCode != null and customerCode != ''">
                and a.customer_code = #{customerCode}
            </if>
            <if test="orderStatus != null and orderStatus != ''">
                <choose>
					<when test="orderStatus == '3'">
						and a.order_status in ('3','5','6')
					</when>
                    <otherwise>
						and a.order_status = #{orderStatus}
					</otherwise>
				</choose>
            </if>
            <if test="orderType != null and orderType != ''">
                and a.order_type = #{orderType}
            </if>
            <if test="id != null and id != ''">
                and a.id = #{id}
            </if>
            and a.del_flag = '0'
        </where>
        order by a.create_date desc
    </select>

	<select id="getOrderDetail" resultMap="OrderInfoDetail">
        select
        <include refid="orderInfoDetailColumns"/>
        from order_info a
        left join member_info m on m.id=a.merchant_code
        left join order_logistics l on l.order_no = a.order_no
        <where>
           a.id = #{id}
        </where>
    </select>

	<select id="findList" resultType="OrderInfo">
		SELECT
			<include refid="orderInfoColumns"/>,
			m.nickname as "merchantName",
		    c.nickname as "customerName",
		    s.status as "settlementStatus",
			um.login_name as "merchantAccount",
			uc.login_name as "customerAccount"
		FROM order_info a
		<include refid="orderInfoJoins"/>
		     left join member_info m on m.id = a.merchant_code
		     left join member_info c on c.id = a.customer_code
		     left join sys_user um on um.id = a.merchant_code
		     left join sys_user uc on uc.id = a.customer_code
		     left join order_settlement s on s.order_id = a.id
		<where>
			<if test="customerCode != null and customerCode != ''">
				and a.customer_code = #{customerCode}
			</if>
			<if test="orderNo != null and orderNo != ''">
				and a.order_no = #{orderNo}
			</if>
			<if test="orderType != null and orderType != ''">
				and a.order_type = #{orderType}
			</if>
			<if test="orderStatus != null and orderStatus != ''">
				and a.order_status = #{orderStatus}
			</if>
			<if test="merchantCode != null and merchantCode != ''">
				and a.merchant_code = #{merchantCode}
			</if>
			<if test="setFlag != null and setFlag != ''">
				and a.set_flag = #{setFlag}
			</if>
			<if test="merchantAccount != null and merchantAccount != ''">
				and um.login_name = #{merchantAccount}
			</if>
			<if test="customerAccount != null and customerAccount != ''">
				and uc.login_name = #{customerAccount}
			</if>
			<if test="startDate != null">
				and a.create_date &gt;= #{startDate}
			</if>
			<if test="endDate != null">
				and a.create_date &lt;= #{endDate}
			</if>

		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				order by a.create_date desc
			</otherwise>
		</choose>
	</select>

	<select id="findAllList" resultType="OrderInfo">
		SELECT
			<include refid="orderInfoColumns"/>
		FROM order_info a
		<include refid="orderInfoJoins"/>
		<where>

		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				order by a.create_date desc
			</otherwise>
		</choose>
	</select>

	<select id="findOrderNos" resultType="OrderInfo">
		select <include refid="orderInfoColumns"/> from order_info a
		<where>
			<if test="paymentNo != null and paymentNo != ''">
				a.payment_no = #{paymentNo}
			</if>
		</where>
	</select>

	<insert id="insert">
		INSERT INTO order_info(
			id,
			order_no,
			merchant_code,
			order_status,
			order_type,
			goods_count,
			goods_amount_total,
			logistics_fee,
			order_amount_total,
			discount_amount_total,
			create_date,
			create_by,
			customer_code,
			remarks,
			pay_time,
			pay_channel_time,
			coupon_code,
			discount_rate,
			payment_no,
		    update_by,
		    update_date,
			closed_time,
			auto_closed_time,
			completed_time,
		    del_flag,
		    settlements_amount,
		    activity_discount_amount,
		    activity_id
		) VALUES (
			#{id},
			#{orderNo},
			#{merchantCode},
			#{orderStatus},
			#{orderType},
			#{goodsCount},
			#{goodsAmountTotal},
			#{logisticsFee},
			#{orderAmountTotal},
			#{discountAmountTotal},
			#{createDate},
			#{createBy.id},
			#{customerCode},
			#{remarks},
			#{payTime},
			#{payChannelTime},
			#{couponCode},
			#{discountRate},
			#{paymentNo},
			#{updateBy.id},
			#{updateDate},
			#{closedTime},
			#{autoClosedTime},
			#{completedTime},
		    #{delFlag},
		    #{settlementsAmount},
		    #{activityDiscountAmount},
		    #{activityId}
		)
	</insert>

	<update id="update">
		UPDATE order_info SET
			order_no = #{orderNo},
			merchant_code = #{merchantCode},
			order_status = #{orderStatus},
			order_type = #{orderType},
			goods_count = #{goodsCount},
			goods_amount_total = #{goodsAmountTotal},
			logistics_fee = #{logisticsFee},
			order_amount_total = #{orderAmountTotal},
			discount_amount_total = #{discountAmountTotal},
			customer_code = #{customerCode},
			remarks = #{remarks},
			pay_time = #{payTime},
			pay_channel_time = #{payChannelTime},
			coupon_code = #{couponCode},
			discount_rate = #{discountRate},
			payment_no = #{paymentNo},
			update_by = #{updateBy.id},
		    update_date = #{updateDate},
		    closed_time = #{closedTime},
		  	auto_closed_time = #{autoClosedTime},
		    completed_time = #{completedTime}
		WHERE id = #{id}
	</update>

    <update id="paySuccessModifyOrderStatus">
        update order_info set order_status = '1', pay_time = now(), pay_channel_time = #{payChannelTime}
        where payment_no = #{paymentNo}
    </update>

	<update id="orderCancel">
		update order_info set order_status = '4', closed_time = now()
		where id = #{id} and customer_code = #{customerCode}
	</update>

	<update id="autoOrderCancel">
		update order_info set order_status = '4', auto_closed_time = now()
		where id = #{id}
	</update>

	<update id="orderComplete">
		update order_info set order_status = '3', completed_time = now()
		where id = #{id} and customer_code = #{customerCode}
	</update>

	<update id="autoOrderComplete">
		update order_info set order_status = '3', auto_completed_time = now()
		where id = #{id}
	</update>

	<update id="orderDelivery">
		update order_info set order_status = '2', delivery_time = now()
		where id = #{id}
	</update>

	<update id="orderSubmitReturns">
		update order_info set order_status = '5'
		where id = #{id}
	</update>

	<update id="orderCompleteReturns">
		update order_info set order_status = '6'
		where id = #{id}
	</update>

	<update id="deleteByUser">
		update order_info set del_flag = '1'
		WHERE id = #{id} and customer_code = #{customerCode}
	</update>

	<update id="remind">
		update order_info set remind_flag = '1' where id = #{id}
	</update>

</mapper>